/**
 * @file Sketch.h
 * @brief è‰å›¾ç±» - CADçš„"ç”»æ¿"ï¼Œæ‰€æœ‰ä¼Ÿå¤§è®¾è®¡çš„èµ·ç‚¹ï¼
 * 
 * è¿™ä¸ªç±»æ˜¯æˆ‘ä»¬2Dè‰å›¾ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œå°±åƒè‰ºæœ¯å®¶çš„ç”»æ¿ä¸€æ ·ï¼Œ
 * æ‰¿è½½ç€å„ç§å‡ ä½•å…ƒç´ ï¼ˆç‚¹ã€çº¿ã€åœ†ã€å¼§ç­‰ï¼‰å’Œçº¦æŸå…³ç³»ã€‚
 * 
 * æƒ³è±¡ä¸€ä¸‹åœ¨çº¸ä¸Šç”»è®¾è®¡å›¾çš„æ„Ÿè§‰ï¼Œåªä¸è¿‡æˆ‘ä»¬çš„"çº¸"æ˜¯æ•°å­—åŒ–çš„ï¼Œ
 * è€Œä¸”è¿˜èƒ½è‡ªåŠ¨ä¿è¯å‡ ä½•å…³ç³»çš„æ­£ç¡®æ€§ï¼è¿™å°±æ˜¯çº¦æŸæ±‚è§£å™¨çš„é­…åŠ› âœ¨
 * 
 * TODO: æ·»åŠ è‰å›¾çš„æ’¤é”€/é‡åšåŠŸèƒ½
 * TODO: å®ç°è‰å›¾çš„å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½
 * TODO: æ”¯æŒè‰å›¾æ¨¡æ¿å’Œå‚æ•°åŒ–è‰å›¾
 * TODO: æ·»åŠ è‰å›¾æ€§èƒ½ç»Ÿè®¡å’Œä¼˜åŒ–å»ºè®®
 */

#pragma once

#include "SketchElement.h"   // è‰å›¾å…ƒç´ åŸºç±» - ä¸‡ç‰©ä¹‹æº
#include "SketchPoint.h"     // ç‚¹å…ƒç´  - æœ€åŸºæœ¬çš„å‡ ä½•è¦ç´ 
#include "SketchLine.h"      // çº¿å…ƒç´  - è¿æ¥ä¸¤ç‚¹çš„æœ€çŸ­è·¯å¾„
#include "SketchCircle.h"    // åœ†å…ƒç´  - å®Œç¾çš„å¯¹ç§°ä¹‹ç¾
#include "SketchArc.h"       // å¼§å…ƒç´  - åœ†çš„ä¸€éƒ¨åˆ†ï¼Œä½†åŒæ ·ç²¾å½©
#include "Constraint.h"      // çº¦æŸåŸºç±» - å‡ ä½•å…³ç³»çš„å®ˆæŠ¤è€…
#include "ConstraintSolver.h" // çº¦æŸæ±‚è§£å™¨ - è®©å‡ ä½•å…³ç³»ä¿æŒå’Œè°çš„é­”æ³•å¸ˆ
#include <vector>            // åŠ¨æ€æ•°ç»„ - å®¹å™¨ç•Œçš„ä¸‡é‡‘æ²¹
#include <memory>            // æ™ºèƒ½æŒ‡é’ˆ - å†…å­˜ç®¡ç†çš„å¾—åŠ›åŠ©æ‰‹
#include <string>            // å­—ç¬¦ä¸² - äººæœºäº¤æµçš„æ¡¥æ¢

namespace cad_sketch {

/**
 * @class Sketch
 * @brief è‰å›¾ç±» - 2Dè®¾è®¡çš„æ•°å­—ç”»æ¿
 * 
 * è¿™ä¸ªç±»ç®¡ç†ç€ä¸€ä¸ªè‰å›¾ä¸­çš„æ‰€æœ‰å…ƒç´ å’Œçº¦æŸå…³ç³»ï¼Œ
 * å°±åƒä¸€ä¸ªä¸¥æ ¼ä½†ä»æ…ˆçš„è€å¸ˆï¼Œæ—¢å…è®¸åˆ›é€ è‡ªç”±ï¼Œ
 * åˆç¡®ä¿ä¸€åˆ‡éƒ½ç¬¦åˆå‡ ä½•é€»è¾‘ ğŸ“
 * 
 * è‰å›¾æ˜¯3Då»ºæ¨¡çš„åŸºç¡€ï¼Œå°±åƒæˆ¿å­çš„åœ°åŸºä¸€æ ·é‡è¦ï¼
 */
class Sketch {
public:
    /** é»˜è®¤æ„é€ å‡½æ•° - åˆ›å»ºä¸€ä¸ªç©ºç™½çš„ç”»æ¿ï¼Œç­‰å¾…è‰ºæœ¯å®¶çš„åˆ›ä½œ */
    Sketch();
    
    /** 
     * æœ‰åå­—çš„æ„é€ å‡½æ•° - ç»™æˆ‘ä»¬çš„ç”»æ¿èµ·ä¸ªå“äº®çš„åå­—
     * @param name è‰å›¾åç§°ï¼Œå°±åƒç”»ä½œçš„æ ‡é¢˜ä¸€æ ·é‡è¦
     */
    Sketch(const std::string& name);
    
    /** ææ„å‡½æ•° - é»˜è®¤å°±å¥½ï¼Œæ™ºèƒ½æŒ‡é’ˆä¼šå¸®æˆ‘ä»¬æ”¶æ‹¾æ®‹å±€ */
    ~Sketch() = default;

    /** 
     * è·å–è‰å›¾åç§° - çœ‹çœ‹è¿™å¹…"ä½œå“"å«ä»€ä¹ˆ
     * @return è‰å›¾çš„åç§°
     */
    const std::string& GetName() const;
    
    /** 
     * è®¾ç½®è‰å›¾åç§° - é‡æ–°ç»™ä½œå“å‘½å
     * @param name æ–°çš„åç§°ï¼Œè¦èµ·å¾—æœ‰æ„ä¹‰å“¦
     */
    void SetName(const std::string& name);
    
    // ========== å…ƒç´ ç®¡ç† - ç”»æ¿ä¸Šçš„"æ¼”å‘˜"ä»¬ ==========
    
    /** 
     * æ·»åŠ å…ƒç´  - åœ¨ç”»æ¿ä¸Šæ·»åŠ æ–°çš„å‡ ä½•å›¾å½¢
     * @param element è¦æ·»åŠ çš„å…ƒç´ ï¼Œå¯ä»¥æ˜¯ç‚¹ã€çº¿ã€åœ†ç­‰
     */
    void AddElement(const SketchElementPtr& element);
    
    /** 
     * ç§»é™¤å…ƒç´  - ä»ç”»æ¿ä¸Šæ“¦æ‰ä¸éœ€è¦çš„å›¾å½¢
     * @param element è¦ç§»é™¤çš„å…ƒç´ 
     */
    void RemoveElement(const SketchElementPtr& element);
    
    /** æ¸…ç©ºæ‰€æœ‰å…ƒç´  - ä¸€é”®æ¸…ç©ºç”»æ¿ï¼Œé‡æ–°å¼€å§‹ */
    void ClearElements();
    
    /** 
     * è·å–æ‰€æœ‰å…ƒç´  - çœ‹çœ‹ç”»æ¿ä¸Šéƒ½æœ‰ä»€ä¹ˆ
     * @return å…ƒç´ åˆ—è¡¨çš„å¸¸é‡å¼•ç”¨
     */
    const std::vector<SketchElementPtr>& GetElements() const;
    
    /** 
     * æ ¹æ®IDæŸ¥æ‰¾å…ƒç´  - åœ¨ä¼—å¤šå…ƒç´ ä¸­æ‰¾åˆ°ç‰¹å®šçš„é‚£ä¸€ä¸ª
     * @param id å…ƒç´ çš„å”¯ä¸€æ ‡è¯†ç¬¦
     * @return æ‰¾åˆ°çš„å…ƒç´ ï¼Œå¦‚æœæ²¡æ‰¾åˆ°åˆ™è¿”å›nullptr
     */
    SketchElementPtr GetElementById(int id) const;
    
    // ========== çº¦æŸç®¡ç† - å‡ ä½•å…³ç³»çš„"æ³•å®˜" ==========
    
    /** 
     * æ·»åŠ çº¦æŸ - ä¸ºå…ƒç´ ä¹‹é—´å»ºç«‹å‡ ä½•å…³ç³»
     * @param constraint çº¦æŸæ¡ä»¶ï¼Œæ¯”å¦‚å¹³è¡Œã€å‚ç›´ã€ç›¸ç­‰ç­‰
     */
    void AddConstraint(const ConstraintPtr& constraint);
    
    /** 
     * ç§»é™¤çº¦æŸ - è§£é™¤å…ƒç´ é—´çš„æŸç§å‡ ä½•å…³ç³»
     * @param constraint è¦ç§»é™¤çš„çº¦æŸ
     */
    void RemoveConstraint(const ConstraintPtr& constraint);
    
    /** æ¸…ç©ºæ‰€æœ‰çº¦æŸ - è®©æ‰€æœ‰å…ƒç´ é‡è·"è‡ªç”±" */
    void ClearConstraints();
    
    /** 
     * è·å–æ‰€æœ‰çº¦æŸ - æŸ¥çœ‹å…ƒç´ é—´éƒ½æœ‰å“ªäº›"è§„åˆ™"
     * @return çº¦æŸåˆ—è¡¨çš„å¸¸é‡å¼•ç”¨
     */
    const std::vector<ConstraintPtr>& GetConstraints() const;
    
    // ========== æ±‚è§£å™¨æ“ä½œ - æ•°å­¦é­”æ³•çš„æ–½å±• ==========
    
    /** 
     * æ±‚è§£çº¦æŸ - è®©çº¦æŸæ±‚è§£å™¨å‘æŒ¥é­”æ³•ï¼Œè°ƒæ•´å…ƒç´ ä½ç½®
     * @return trueè¡¨ç¤ºæ±‚è§£æˆåŠŸï¼Œfalseè¡¨ç¤ºçº¦æŸå†²çªæ— æ³•è§£å†³
     */
    bool SolveConstraints();
    
    /** 
     * éªŒè¯çº¦æŸ - æ£€æŸ¥å½“å‰çš„çº¦æŸç³»ç»Ÿæ˜¯å¦åˆç†
     * @return trueè¡¨ç¤ºçº¦æŸç³»ç»Ÿæ²¡é—®é¢˜ï¼Œfalseè¡¨ç¤ºæœ‰å†²çª
     */
    bool ValidateConstraints() const;
    
    // ========== é€‰æ‹©ç®¡ç† - å‘Šè¯‰ç¨‹åºç”¨æˆ·å…³æ³¨ä»€ä¹ˆ ==========
    
    /** 
     * é€‰æ‹©å…ƒç´  - æŠŠæŸä¸ªå…ƒç´ æ ‡è®°ä¸º"é‡ç‚¹å…³æ³¨å¯¹è±¡"
     * @param element è¦é€‰æ‹©çš„å…ƒç´ 
     */
    void SelectElement(const SketchElementPtr& element);
    
    /** 
     * å–æ¶ˆé€‰æ‹©å…ƒç´  - ä¸å†å…³æ³¨æŸä¸ªå…ƒç´ 
     * @param element è¦å–æ¶ˆé€‰æ‹©çš„å…ƒç´ 
     */
    void DeselectElement(const SketchElementPtr& element);
    
    /** æ¸…ç©ºé€‰æ‹© - ä¸å…³æ³¨ä»»ä½•å…ƒç´ ï¼Œå›åˆ°"ä½›ç³»"çŠ¶æ€ */
    void ClearSelection();
    
    /** 
     * è·å–é€‰ä¸­çš„å…ƒç´  - çœ‹çœ‹ç”¨æˆ·ç°åœ¨å…³æ³¨å“ªäº›å…ƒç´ 
     * @return å½“å‰é€‰ä¸­çš„å…ƒç´ åˆ—è¡¨
     */
    std::vector<SketchElementPtr> GetSelectedElements() const;
    
    // ========== å®ç”¨å·¥å…·æ–¹æ³• - ä¾¿æ°‘å°åŠ©æ‰‹ ==========
    
    /** 
     * æ£€æŸ¥æ˜¯å¦ä¸ºç©º - çœ‹çœ‹ç”»æ¿ä¸Šæ˜¯ä¸æ˜¯è¿˜æ˜¯ä¸€ç‰‡ç©ºç™½
     * @return trueè¡¨ç¤ºç©ºè‰å›¾ï¼Œfalseè¡¨ç¤ºæœ‰å†…å®¹
     */
    bool IsEmpty() const;
    
    /** 
     * è·å–å…ƒç´ æ•°é‡ - æ•°æ•°ç”»æ¿ä¸Šæœ‰å¤šå°‘ä¸ªå›¾å½¢
     * @return å…ƒç´ çš„æ€»æ•°
     */
    int GetElementCount() const;
    
    /** 
     * è·å–çº¦æŸæ•°é‡ - æ•°æ•°æœ‰å¤šå°‘æ¡å‡ ä½•è§„åˆ™
     * @return çº¦æŸçš„æ€»æ•°
     */
    int GetConstraintCount() const;

private:
    /** è‰å›¾åç§° - è¿™å¹…"ä½œå“"çš„æ ‡é¢˜ */
    std::string m_name;
    
    /** è‰å›¾å…ƒç´ é›†åˆ - ç”»æ¿ä¸Šçš„æ‰€æœ‰"æ¼”å‘˜" */
    std::vector<SketchElementPtr> m_elements;
    
    /** çº¦æŸé›†åˆ - ç»´æŠ¤ç§©åºçš„"è§„åˆ™æ¡æ–‡" */
    std::vector<ConstraintPtr> m_constraints;
    
    /** çº¦æŸæ±‚è§£å™¨ - è´Ÿè´£è°ƒè§£å…ƒç´ å…³ç³»çš„"å’Œäº‹ä½¬" */
    ConstraintSolver m_solver;
};

/** è‰å›¾æ™ºèƒ½æŒ‡é’ˆç±»å‹åˆ«å - è®©å†…å­˜ç®¡ç†å˜å¾—è½»æ¾æ„‰å¿« */
using SketchPtr = std::shared_ptr<Sketch>;

} // namespace cad_sketch